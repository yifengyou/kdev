#==========================================================================
# Description: Build qcow2 test
#==========================================================================


name: Build qcow2 test
on:
  workflow_dispatch:  # 手动触发
  push:
    tags: v*          # 打标签时自动触发

jobs:
  build:
    runs-on: ubuntu-latest  # 需支持嵌套虚拟化（建议自托管运行器）
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install KVM/QEMU
        run: |
          sudo apt update
          sudo apt install -y qemu-kvm libvirt-daemon-system virtinst cpu-checker rar
          sudo systemctl enable --now libvirtd
          sudo mkdir -p /builder/
          sudo mkdir -p /builder/release
          sudo chown -R runner.runner /builder

      - name: Clone kdev project
        id: clone_kdev
        working-directory: /builder/
        run: |
          git clone -q --single-branch --depth=1 --branch=master https://github.com/yifengyou/kdev.git kdev.git
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Start VM Installation
        id: build_vm
        run: |
          sudo chmod 777 /dev/kvm
          ls -alh /dev/kvm
          cd /builder/kdev.git/ubuntu/ubuntu24.04/qcow2/x86_64 && sudo ./build-vm.sh
          sudo virsh list --all
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Compress rootfs.qcow2
        id: compress_output
        run: |
          cd /builder/kdev.git/ubuntu/ubuntu24.04/qcow2/x86_64 && \
            zstd --rm -9 rootfs.qcow2 -o /builder/release/rootfs.qcow2.zst && \
            rar a /builder/release/rootfs.img.rar rootfs.qcow2
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Upload rootfs qcow2 to release
        uses: ncipollo/release-action@main
        if: ${{ steps.compress_output.outputs.status }} == 'success' && !cancelled()
        with:
          tag: "kdev_release"
          artifacts: /builder/*
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### kdev release
            - 默认用户名(Default username): root
            - 默认密码(Default password): linux
